<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<title>Anytype</title>

		<script src="./js/jquery.js"></script>

		<style type="text/css">
			:root {
				--color-text-primary: #252525;
				--color-text-secondary: #828282;
				--color-bg-primary: #fff;
				--color-shape-tertiary: #f2f2f2;
				--color-shape-highlight-dark: rgba(0, 0, 0, 0.11);
				--color-shape-highlight-medium: rgba(0, 0, 0, 0.05);
			}

			* { margin: 0px; padding: 0px; box-sizing: border-box; user-select: none; }
	
			@font-face {
				font-family: 'Inter'; font-style: normal; font-weight: 500;
				src: url('./font/inter/medium.woff2') format('woff2');
			}

			body { 
				font-family: 'Inter', sans-serif; font-size: 14px; color: var(--color-text-primary); background: transparent; 
				font-weight: 500; line-height: 22px; letter-spacing: -0.12px; padding: 8px;
			}
			body.platform-darwin { padding-left: 88px; }

			.container { position: relative; }

			#tabs { display: flex; flex-direction: row; background: var(--color-shape-tertiary); border-radius: 18px; }
			#marker { 
				width: 200px; height: calc(100% - 4px); background: var(--color-bg-primary); left: 2px; top: 2px; position: absolute; 
				border-radius: 16px; z-index: 1;
			}
			#marker.anim { transition: all 0.2s ease-in-out; }

			.icon { width: 20px; height: 20px; background-size: contain; background-position: center; background-repeat: no-repeat; }
			.icon.withBackground { border-radius: 10px; }
			.icon.withBackground:hover { background-color: var(--color-shape-highlight-medium); }

			.tab {
				padding: 6px; cursor: default; min-width: 80px; max-width: 204px; flex: 1 1 204px;
				color: var(--color-text-secondary);
				display: flex; flex-direction: row; align-items: center; position: relative;
			}

			.tab.noClose {
				.icon.close { display: none !important; }
			}

			.tab.active { color: var(--color-text-primary); }
			.tab.active {
				.div { display: none; }
			}

			.tab:has(+ .tab.active) .div { display: none; }

			.tab.isAdd { flex: 0 0 auto; }
			.tab.isAdd {
				.icon { background-image: url('./img/icon/plus.svg'); }
			}

			.tab {
				.clickable {
					display: flex; flex-direction: row; gap: 0px 6px; align-items: center; position: relative; z-index: 2;
					overflow: hidden; flex-grow: 1; padding-left: 6px;
				}
				.name { height: 20px; line-height: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
				.icon { background-size: 18px; flex-shrink: 0; }
				.icon.close { background-image: url('./img/icon/close.svg'); }

				.div {
					position: absolute; width: 1px; top: 50%; margin-top: -10px; height: 20px; background: var(--color-shape-highlight-dark);
					z-index: 0; right: 0px;
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div id="tabs"></div>
			<div id="marker"></div>
		</div>

		<script type="text/javascript">
			$(document).ready(() => {
				const body = $('body');
				const electron = window.Electron;
				const currentWindow = electron.currentWindow();
				const winId = Number(currentWindow?.windowId) || 0;
				const container = $('#tabs');
				const marker = $('#marker');

				body.addClass(`platform-${electron.platform}`);

				const setActive = (id, animate) => {
					container.find('.tab.active').removeClass('active');

					const active = container.find(`#tab-${id}`);
					if (!active.length) {
						return;
					};

					const offset = active.position();

					active.addClass('active');

					marker.toggleClass('anim', animate);
					marker.css({
						width: active.outerWidth(),
						transform: `translate3d(${offset.left}px, 0px, 0px)`
					});
				};

				const renderTab = (item) => {
					item = item || {};
					item.data = item.data || {};

					const title = String(item.data.title || 'New tab');
					const icon = String(item.data.icon || '');

					const tab = $(`
						<div id="tab-${item.id}" class="tab">
							<div class="clickable">
								<div class="name">${title}</div>
								<div class="icon close withBackground"></div>
							</div>
							<div class="div"></div>
						</div>
					`);

					const clickable = tab.find('.clickable');
					if (icon) {
						clickable.prepend($(`<div class="icon" style="background-image: url('${icon}')" />`));
					};

					clickable.off('click').on('click', () => {
						electron.Api(winId, 'setActiveTab', item.id);
						setActive(item.id, true);
					});

					tab.find('.icon.close').off('click').on('click', (e) => {
						e.stopPropagation();
						electron.Api(winId, 'removeTab', [ item.id, true ]);
					});

					return tab;
				};

				const renderAdd = () => {
					const tab = $(`
						<div class="tab isAdd">
							<div class="icon withBackground"></div>
						</div>
					`);

					tab.off('click').on('click', () => {
						electron.Api(winId, 'createTab');
					});

					return tab;
				};

				const updateNoClose = () => {
					const tabs = container.find('.tab:not(.isAdd)');
					tabs.toggleClass('noClose', tabs.length == 1);
				};

				const setTabs = (tabs, id) => {
					container.empty();

					tabs = tabs || [];
					tabs.forEach((it, i) => {
						container.append(renderTab(it));
					});

					container.append(renderAdd());
					updateNoClose();
					setActive(id, false);
				};

				electron.Api(winId, 'getTabs').then(({ tabs, id }) => setTabs(tabs, id));

				electron.on('update-tabs', (e, tabs, id) => setTabs(tabs, id));

				electron.on('set-active-tab', (e, id) => setActive(id, false));

				electron.on('create-tab', (e, tab) => {
					const existing = container.find(`#tab-${tab.id}`);
					if (!existing.length) {
						container.find('.tab.isAdd').before(renderTab(tab));
						updateNoClose();
					};
				});

				electron.on('update-tab', (e, tab) => {
					const existing = container.find(`#tab-${tab.id}`);
					if (existing.length) {
						existing.replaceWith(renderTab(tab));
					};
				});

				electron.on('remove-tab', (e, id) => {
					container.find(`#tab-${id}`).remove();
					updateNoClose();
				});
			});
		</script>
	</body>
</html>